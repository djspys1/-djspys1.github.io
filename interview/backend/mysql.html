<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mysql优化 | 个人文档</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="小鹏个人文档">
    <meta name="keywords" content="小鹏,blog,djspys,bbr,chrome,firewall,前端面试,table,html,vue,css,php,xampp,redis">
    <link rel="preload" href="/assets/css/0.styles.4a3e1b49.css" as="style"><link rel="preload" href="/assets/js/app.c6b1cc19.js" as="script"><link rel="preload" href="/assets/js/2.6601f5ed.js" as="script"><link rel="preload" href="/assets/js/7.e0c55023.js" as="script"><link rel="prefetch" href="/assets/js/10.20b79bb5.js"><link rel="prefetch" href="/assets/js/11.26d0d302.js"><link rel="prefetch" href="/assets/js/12.f5255ec0.js"><link rel="prefetch" href="/assets/js/13.f512610d.js"><link rel="prefetch" href="/assets/js/14.51a90532.js"><link rel="prefetch" href="/assets/js/15.8b5c556e.js"><link rel="prefetch" href="/assets/js/16.54c39e8c.js"><link rel="prefetch" href="/assets/js/17.d9e7f651.js"><link rel="prefetch" href="/assets/js/18.160532be.js"><link rel="prefetch" href="/assets/js/19.cd5f0081.js"><link rel="prefetch" href="/assets/js/20.d62776c2.js"><link rel="prefetch" href="/assets/js/21.a639e316.js"><link rel="prefetch" href="/assets/js/22.449d3446.js"><link rel="prefetch" href="/assets/js/23.86927b1c.js"><link rel="prefetch" href="/assets/js/3.5cc68ab4.js"><link rel="prefetch" href="/assets/js/4.f15acc75.js"><link rel="prefetch" href="/assets/js/5.71a9b689.js"><link rel="prefetch" href="/assets/js/6.862a2a88.js"><link rel="prefetch" href="/assets/js/8.4ef47606.js"><link rel="prefetch" href="/assets/js/9.98d476fd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4a3e1b49.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试题" class="dropdown-title"><span class="title">面试题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/fronted/javascript.html" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/interview/backend/php.html" class="nav-link">
  后端
</a></li></ul></div></div><div class="nav-item"><a href="/knowledge/table.html" class="nav-link">
  小技巧
</a></div><div class="nav-item"><a href="/server/bbr.html" class="nav-link">
  服务器
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试题" class="dropdown-title"><span class="title">面试题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/fronted/javascript.html" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/interview/backend/php.html" class="nav-link">
  后端
</a></li></ul></div></div><div class="nav-item"><a href="/knowledge/table.html" class="nav-link">
  小技巧
</a></div><div class="nav-item"><a href="/server/bbr.html" class="nav-link">
  服务器
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/interview/backend/php.html" class="sidebar-link">php</a></li><li><a href="/interview/backend/mysql.html" class="active sidebar-link">mysql优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview/backend/mysql.html#对mysql进行优化的前提是了解为何会慢以及如何优化" class="sidebar-link">对mysql进行优化的前提是了解为何会慢以及如何优化</a></li><li class="sidebar-sub-header"><a href="/interview/backend/mysql.html#常用方法" class="sidebar-link">常用方法</a></li><li class="sidebar-sub-header"><a href="/interview/backend/mysql.html#特定方法的优化" class="sidebar-link">特定方法的优化</a></li><li class="sidebar-sub-header"><a href="/interview/backend/mysql.html#使用explain语句让mysql解释它将如何执行一条select语句" class="sidebar-link">使用EXPLAIN语句让MySQL解释它将如何执行一条SELECT语句</a></li><li class="sidebar-sub-header"><a href="/interview/backend/mysql.html#show-processlist查看所有进程以确定执行缓慢的原因，kill用于杀死特定进程" class="sidebar-link">show processlist查看所有进程以确定执行缓慢的原因，kill用于杀死特定进程</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql优化"><a href="#mysql优化" class="header-anchor">#</a> mysql优化</h1> <h2 id="对mysql进行优化的前提是了解为何会慢以及如何优化"><a href="#对mysql进行优化的前提是了解为何会慢以及如何优化" class="header-anchor">#</a> 对mysql进行优化的前提是了解为何会慢以及如何优化</h2> <p> 对一个查询而言，真正重要的是响应时间，如果把查询看作一个任务，那么它就是由一系列子任务组成的，我们要做的就是消除一些其中的子任务或者减少子任务的执行次数或者加快子任务的执行速度</p> <h2 id="常用方法"><a href="#常用方法" class="header-anchor">#</a> 常用方法</h2> <h3 id="_1-增加缓存以减少数据库访问"><a href="#_1-增加缓存以减少数据库访问" class="header-anchor">#</a> 1.增加缓存以减少数据库访问</h3> <h3 id="_2-明确查询的条数时使用limit限制"><a href="#_2-明确查询的条数时使用limit限制" class="header-anchor">#</a> 2.明确查询的条数时使用limit限制</h3> <h3 id="_3-select明确字段取代select"><a href="#_3-select明确字段取代select" class="header-anchor">#</a> 3.select明确字段取代select *</h3> <ul><li>取出全部的列会让优化器无法完成索引覆盖扫描这类优化，还会为服务器带来额外的I/O，内存和CPU消耗。</li> <li>不使用<code>select *</code>不代表不能查询返回超过需要的数据，在使用缓存机制或者后续的代码复用上，返回更多的数据也可能对整个应用带来更多的好处。</li></ul> <h3 id="_4-除非有真实需要，否则尽可能使用not-null以避免null判断"><a href="#_4-除非有真实需要，否则尽可能使用not-null以避免null判断" class="header-anchor">#</a> 4.除非有真实需要，否则尽可能使用not null以避免null判断</h3> <h3 id="_5-搜索字段建立索引，但需要合理使用"><a href="#_5-搜索字段建立索引，但需要合理使用" class="header-anchor">#</a> 5.搜索字段建立索引，但需要合理使用</h3> <h3 id="_6-合适的搜索引擎（5-6版本及以上）"><a href="#_6-合适的搜索引擎（5-6版本及以上）" class="header-anchor">#</a> 6.合适的搜索引擎（5.6版本及以上）</h3> <ul><li>innodb，默认引擎也是最常用的引擎。</li> <li>支持b-tree索引</li> <li>支持备份/时间点恢复</li> <li>支持聚集索引</li> <li>支持压缩数据</li> <li>支持数据缓存</li> <li>支持数据加密，5.7版本后支持<code>Data-at-rest tablespace encryption</code></li> <li>支持外键</li> <li>5.6之后支持全文索引</li> <li>支持地理数据类型</li> <li>支持地理索引，（5.7以后）</li> <li>支持索引缓存</li> <li>支持行级锁定</li> <li>支持mvcc</li> <li>支持复制</li> <li>存储限制64TB</li> <li>支持事务</li> <li>支持<code>Update statistics for data dictionary</code></li> <li>myisam,5.1之前默认引擎</li> <li>支持b-tree索引</li> <li>支持备份/时间点恢复</li> <li>支持压缩数据（只有压缩行格式才支持，且使用后未只读格式）</li> <li>支持数据加密，5.7版本后支持<code>Data-at-rest tablespace encryption</code></li> <li>支持全文索引</li> <li>支持地理数据类型</li> <li>支持地理索引</li> <li>支持表级锁定</li> <li>存储限制256TB</li> <li>支持<code>Update statistics for data dictionary</code></li> <li>这二个是最常用的，根据自身的情况来选择合适的引擎</li></ul> <h3 id="_7-慢查询日志"><a href="#_7-慢查询日志" class="header-anchor">#</a> 7.慢查询日志</h3> <p> 可以对查询慢的sql进行记录分析，然后通过肉眼debug或者使用mysqldumpslow进行分析,最好是在调试的时候开启，或者通过shell将日志设为按天记录,删除时间较长的记录等方法。</p> <ul><li><code>show variables like 'slow_query_log'</code> 查看慢查询是否开启</li> <li><code>set global slow_query_log_file = '/home/mysql/sql_log/mysql-slow.log'</code>将慢查询日志记录到指定文件中</li> <li><code>set global log_queries_not_using_indexes = on;</code> // 开启未使用索引的日志时间记录</li> <li><code>set global long_query_time=1</code> 慢查询的阙值</li> <li><code>set global slow_query_log=on</code> 开启慢查询</li></ul> <p> 通过命令行开启的会在重启时关闭，要永久生效，可以修改mysql配置文件</p> <h3 id="_8-合适的字段属性，注意一下几个原则"><a href="#_8-合适的字段属性，注意一下几个原则" class="header-anchor">#</a> 8.合适的字段属性，注意一下几个原则</h3> <ul><li>更小的通常更好，尽量选取可以正确存储数据的最小数据类型。这样会占用更小的磁盘，内存和缓存，并且处理是需要的cpu周期也更短</li> <li>简单就好，比如整型比字符串的代价更低，因为字符集和校对规则使字符比较比整型比较更复杂</li> <li>unsigned的使用，unsigned代表无符号，可以使正数的上限提高将近一倍，如tinyint.unsigned是0~255，而不加unsigned范围是-128~127</li></ul> <h3 id="_9-尽量少使用通配符，如有必要，在使用通配符搜索时，除非有必要，否则不要将其放在搜索模式的开始处"><a href="#_9-尽量少使用通配符，如有必要，在使用通配符搜索时，除非有必要，否则不要将其放在搜索模式的开始处" class="header-anchor">#</a> 9.尽量少使用通配符，如有必要，在使用通配符搜索时，除非有必要，否则不要将其放在搜索模式的开始处</h3> <h3 id="_10-对不常用的字段进行冗余处理以避免关联查询呢"><a href="#_10-对不常用的字段进行冗余处理以避免关联查询呢" class="header-anchor">#</a> 10.对不常用的字段进行冗余处理以避免关联查询呢</h3> <h3 id="_11-某些特定情况下，可以增加缓存表和汇总表"><a href="#_11-某些特定情况下，可以增加缓存表和汇总表" class="header-anchor">#</a> 11.某些特定情况下，可以增加缓存表和汇总表</h3> <h2 id="特定方法的优化"><a href="#特定方法的优化" class="header-anchor">#</a> 特定方法的优化</h2> <h3 id="_1-count的优化"><a href="#_1-count的优化" class="header-anchor">#</a> 1.<code>count</code>的优化</h3> <ul><li>首先了解一下count的特性</li> <li>count()用于统计某个列值的数量或者统计行数，在统计列值时要求列为非空</li> <li>count(*)不会扩展成所有的列，他会直接统计所有的行数</li> <li>myisam的count会非常快，不过这是有前提条件的，它只有没有任何where条件下才快，因为这时候不用去计算表的行数，直接利用存储引擎的特性获取值.因此，在带有where语句进行统计时，myisam和innodb并没有什么区别</li> <li>在统计某个列的值，而mysql知道这个列不可能为null，mysql内部实际会将其优化为count(*)</li> <li>简单优化</li> <li>在进行带条件的查询时，有时候可以一些小技巧来进行统计，如在统计查询id大于等于5的行数时，可以查询id小于5的函数，然后用总行数减去查出的函数。</li> <li>使用近似值，计算精确值的代价是很高的，在某些场景中并不需要精确值，有一个近似值就可以满足需求，使用explain获取的估算值或者可以每隔一段时间进行统计后放入缓存</li> <li>复杂优化</li> <li>使用索引覆盖扫描</li> <li>增加汇总表</li> <li>使用redis,memcached等外部缓存系统</li></ul> <h3 id="_2-分页查询的优化"><a href="#_2-分页查询的优化" class="header-anchor">#</a> 2.分页查询的优化</h3> <ul><li><code>select user,content from logs where name='zhangsan' order by created_time limit 100000, 10;</code>这是一个很常见的分页排序查询，但是无论创建合种索引，这种查询都是个很严重的问题，随着偏移量的增大，mysql需要扫描丢弃的数据越来越大，此时，预先计算，增加缓存，反范式化，加标签是可选的方法，更好的方法限制用户能够翻页的数量（百度限制为76页），这对用户的体验影响不大，因为很少会搜索10000页以后的数据。</li> <li>优化该类索引的一个好点的方法是使用延迟关联，通过使用覆盖索引查询返回需要的主键，再根据这些主键关联原表获得需要的行
<code>select user,content from logs inner join (select id from logs where name='zhaangsan' order by created_time limit 100000, 10) as x using(id)</code></li> <li>某些情况下，可以使用<code>between...and</code>来代替<code>limit offset</code></li></ul> <h3 id="_3-关联查询的优化"><a href="#_3-关联查询的优化" class="header-anchor">#</a> 3.关联查询的优化</h3> <ul><li>确保<code>group by</code>和<code>order by</code>中的表达式只涉及到一个表中的列以便mysql使用索引来进行优化</li> <li>关联表的顺序也会对速度有一定的影响，尽可能的以小的表来驱动大的表，具体的执行可以使用explain来进行一步步的实验分析</li> <li>一般情况下，可以在关联顺序的第二个表的相应列上加上索引</li></ul> <h3 id="_4-子查询优化"><a href="#_4-子查询优化" class="header-anchor">#</a> 4.子查询优化</h3> <ul><li>5.6版本前的优化是尽可能使用关联查询来代替子查询</li></ul> <h3 id="_5-group-by与distinct优化"><a href="#_5-group-by与distinct优化" class="header-anchor">#</a> 5.<code>group by</code>与<code>distinct</code>优化</h3> <ul><li>这二种都可以使用索引来进行优化</li> <li>在无法使用索引的情况下，<code>group by</code>使用临时表或者文件排序来做分组，可以通过使用提示<code>sql_big_result</code>和<code>sql_small_result</code>来让优化器按照指定方式运行</li> <li>在对关联查询进行分组时，查找表的标识列进行分组的效率要比其他列高</li></ul> <h2 id="使用explain语句让mysql解释它将如何执行一条select语句"><a href="#使用explain语句让mysql解释它将如何执行一条select语句" class="header-anchor">#</a> 使用EXPLAIN语句让MySQL解释它将如何执行一条SELECT语句</h2> <h2 id="show-processlist查看所有进程以确定执行缓慢的原因，kill用于杀死特定进程"><a href="#show-processlist查看所有进程以确定执行缓慢的原因，kill用于杀死特定进程" class="header-anchor">#</a> show processlist查看所有进程以确定执行缓慢的原因，kill用于杀死特定进程</h2></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/interview/backend/php.html" class="prev">
        php
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c6b1cc19.js" defer></script><script src="/assets/js/2.6601f5ed.js" defer></script><script src="/assets/js/7.e0c55023.js" defer></script>
  </body>
</html>
